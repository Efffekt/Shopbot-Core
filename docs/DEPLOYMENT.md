# Deployment Guide (Vercel)

## Prerequisites

- A Vercel account connected to your GitHub repository
- All environment variables ready (see [ENVIRONMENT.md](./ENVIRONMENT.md))

## 1. Connect to Vercel

1. Go to [vercel.com](https://vercel.com) and import the GitHub repository
2. Vercel auto-detects Next.js — no framework config needed
3. The build command is already configured in `package.json`: `npm run build:widget && next build`

## 2. Set Environment Variables

In the Vercel project dashboard, go to **Settings > Environment Variables** and add all variables from `.env.example`.

Important notes:
- `CRON_SECRET` is auto-generated by Vercel after the first deploy with `vercel.json`
- Use Vercel's Upstash integration for automatic Redis env var injection, or add `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN` manually
- Never add `NEXT_PUBLIC_` prefixed variables with secret values — they're exposed to the browser

## 3. Deploy

Push to `main` to trigger a production deployment:

```bash
git push origin main
```

Vercel automatically:
- Builds the widget (`scripts/build-widget.mjs`)
- Builds the Next.js app
- Deploys to the production domain

## 4. Verify Deployment

After deploy, verify:

1. **Health check**: `GET /api/health` should return `200 OK`
2. **Cron job**: Check Vercel Dashboard > Cron Jobs — the daily credit reset should appear
3. **Widget**: Visit a tenant's site and verify the chat widget loads
4. **Dashboard**: Log in at `/login` and verify tenant dashboard works

## 5. Custom Domain

1. In Vercel, go to **Settings > Domains**
2. Add your domain (e.g., `preik.ai`)
3. Configure DNS as instructed by Vercel (CNAME or A record)
4. SSL is automatic

## Cron Jobs

Configured in `vercel.json`:

| Schedule | Path | Description |
|----------|------|-------------|
| Daily 02:00 UTC | `/api/cron/reset-credits` | Resets credits for tenants with expired billing cycles |

## Monitoring

- **Logs**: Vercel Dashboard > Logs (or set up a log drain for structured JSON logs)
- **Functions**: Vercel Dashboard > Functions — monitor execution time and errors
- **Cron**: Vercel Dashboard > Cron Jobs — check execution history

## Rollback

If a deploy causes issues:

1. Go to Vercel Dashboard > Deployments
2. Find the last working deployment
3. Click the three-dot menu > **Promote to Production**
